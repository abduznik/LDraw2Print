name: Build LDraw2Print

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g. v1.0.0)'
        required: true
        default: 'v1.0.0'
      title:
        description: 'Release Title'
        required: true
        default: 'Manual Build'
  release:
    types: [created]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Download Blender 4.5 (Daily)
      shell: powershell
      run: |
        $Url = "https://builder.blender.org/download/daily/"
        Write-Host "Fetching $Url..."
        $Page = Invoke-WebRequest -Uri $Url -UseBasicParsing
        
        # Debug: Check if we got content
        Write-Host "Page content length: $($Page.Content.Length)"
        
        # Regex: Look for 'href=' followed by anything containing 'blender-4.5' and 'windows-amd64.zip'
        # The page structure usually has <a href="/download/daily/blender-4.5.0-alpha+main.HASH.windows.amd64.zip">
        if ($Page.Content -match 'href="([^"]*blender-4\.5[^"]*-windows-amd64\.zip)"') {
            $Link = $matches[1]
            Write-Host "Found Link: $Link"
        } else {
            Write-Error "Could not find Blender 4.5 download link! Page content might have changed."
            # Debug: Print first 500 chars to see what's wrong
            Write-Host $Page.Content.Substring(0, [math]::Min(500, $Page.Content.Length))
            exit 1
        }
        
        if ($Link -notlike "http*") { 
            $Link = "https://builder.blender.org$Link" 
        }
        
        Write-Host "Downloading Blender from: $Link"
        Invoke-WebRequest -Uri $Link -OutFile "blender.zip"
        
        # Extract
        7z x blender.zip -oblender-tmp
        
        # Move inner folder to 'blender-diet' (Handle variable directory name)
        $InnerDir = Get-ChildItem -Path "blender-tmp" -Directory | Select-Object -First 1
        Move-Item -Path $InnerDir.FullName -Destination "blender-diet"

    - name: Install ImportLDraw Addon
      shell: powershell
      run: |
        git clone https://github.com/TobyLobster/ImportLDraw.git
        $Dest = "blender-diet/4.5/scripts/addons_core/io_scene_importldraw"
        New-Item -ItemType Directory -Force -Path $Dest
        Copy-Item -Recurse -Path "ImportLDraw/*" -Destination $Dest

    - name: Diet Blender (Strip Components)
      shell: powershell
      run: |
        $diet = "blender-diet"
        Remove-Item "$diet\*.pdf", "$diet\*.txt", "$diet\*.html", "$diet\copyright.txt", "$diet\readme.html" -ErrorAction SilentlyContinue
        Remove-Item "$diet\lib", "$diet\doc", "$diet\license" -Recurse -Force -ErrorAction SilentlyContinue
        Remove-Item "$diet\blender-launcher.exe" -ErrorAction SilentlyContinue
        Remove-Item "$diet\blender.pdb" -Force -ErrorAction SilentlyContinue
        Remove-Item "$diet\cycles_kernel_*.dll" -ErrorAction SilentlyContinue
        Remove-Item "$diet\hiprt64.dll" -ErrorAction SilentlyContinue
        Remove-Item "$diet\blender.shared\OpenImageDenoise_device_*.dll" -ErrorAction SilentlyContinue
        $addons = "$diet\4.5\scripts\addons_core"
        $list = @("cycles", "hydra_storm", "io_scene_fbx", "io_scene_gltf2", "rigify", "pose_library", "io_anim_bvh", "io_curve_svg", "io_mesh_uv_layout", "node_wrangler", "ui_translate", "viewport_vr_preview")
        foreach ($item in $list) { Remove-Item "$addons\$item" -Recurse -Force -ErrorAction SilentlyContinue }
        Remove-Item "$diet\4.5\datafiles\studiolights", "$diet\4.5\datafiles\icons" -Recurse -Force -ErrorAction SilentlyContinue

    - name: Patch Addon (No Cycles Dependency)
      shell: powershell
      run: |
        $File = "blender-diet/4.5/scripts/addons_core/io_scene_importldraw/loadldraw/loadldraw.py"
        $Content = Get-Content $File -Raw
        $Content = $Content.Replace("scene.render.engine = 'CYCLES'", "try:`n        scene.render.engine = 'CYCLES'`n    except:`n        pass")
        $Content = $Content.Replace("scene.cycles.film_transparent = True", "try:`n        scene.cycles.film_transparent = True`n    except:`n        pass")
        Set-Content -Path $File -Value $Content

    - name: Package
      shell: powershell
      run: |
        New-Item -ItemType Directory -Force -Path "dist/LDraw2Print"
        Move-Item -Path "blender-diet" -Destination "dist/LDraw2Print/blender"
        Copy-Item -Path "export_cli.py" -Destination "dist/LDraw2Print/converter.py"
        $BatContent = @"
        @echo off
        setlocal
        set "TARGET=%~1"
        if "%TARGET%"=="" (
            echo Drag and drop an .ldr file onto this script!
            pause
            exit /b
        )
        echo Processing: %TARGET%
        "%~dp0blender\blender.exe" --background --python "%~dp0converter.py" -- "%TARGET%" "%~dp0export_output"
        echo Done! Output is in the export_output folder.
        pause
        "@
        Set-Content -Path "dist/LDraw2Print/LDraw2Print.bat" -Value $BatContent
        
        # Zip naming uses version input
        $ZipName = "LDraw2Print-${{ github.event.inputs.version }}.zip"
        if ("${{ github.event.inputs.version }}" -eq "") { $ZipName = "LDraw2Print-build.zip" }
        Compress-Archive -Path "dist/LDraw2Print" -DestinationPath "$ZipName"
        echo "ZIP_NAME=$ZipName" >> $env:GITHUB_ENV

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.ZIP_NAME }}
        path: ${{ env.ZIP_NAME }}
