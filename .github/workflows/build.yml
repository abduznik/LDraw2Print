name: Build LDraw2Print

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g. v1.0.0)'
        required: true
        default: 'v1.0.0'
      title:
        description: 'Release Title'
        required: true
        default: 'Manual Build'
  release:
    types: [created]

permissions: 
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Download Blender 4.5 (Daily)
      shell: powershell
      run: |
        $DailyUrl = "https://builder.blender.org/download/daily/"
        $FallbackUrl = "https://download.blender.org/release/Blender4.3/blender-4.3.2-windows-x64.zip"
        $Link = $null

        Write-Host "Attempting to scrape daily build from $DailyUrl..."
        try {
            $Page = Invoke-WebRequest -Uri $DailyUrl -UseBasicParsing -ErrorAction Stop
            if ($Page.Content -match '(?i)href="([^\"]*blender-4.5[^\"]*windows[^\"]*\.zip)"') {
                $Link = $matches[1]
                Write-Host "Found Daily Link: $Link"
            }
        } catch {
            Write-Warning "Scraping failed: $_"
        }

        if (-not $Link) {
            Write-Warning "Could not find Blender 4.5 Daily. Falling back to Blender 4.3 LTS Stable."
            $Link = $FallbackUrl
        }
        
        if ($Link -notlike "http*") { $Link = "https://builder.blender.org$Link" }
        Write-Host "Downloading Blender from: $Link"
        Invoke-WebRequest -Uri $Link -OutFile "blender.zip"
        
        7z x blender.zip -oblender-tmp
        $InnerDir = Get-ChildItem -Path "blender-tmp" -Directory | Select-Object -First 1
        Move-Item -Path $InnerDir.FullName -Destination "blender-diet"

    - name: Install ImportLDraw Addon
      shell: powershell
      run: |
        git clone https://github.com/TobyLobster/ImportLDraw.git
        $Dest = "blender-diet/4.5/scripts/addons_core/io_scene_importldraw"
        New-Item -ItemType Directory -Force -Path $Dest
        Copy-Item -Recurse -Path "ImportLDraw/*" -Destination $Dest

    - name: Diet Blender (Strip Components)
      shell: powershell
      run: |
        $diet = "blender-diet"
        Remove-Item "$diet\*.pdf", "$diet\*.txt", "$diet\*.html", "$diet\copyright.txt", "$diet\readme.html" -ErrorAction SilentlyContinue
        Remove-Item "$diet\lib", "$diet\doc", "$diet\license" -Recurse -Force -ErrorAction SilentlyContinue
        Remove-Item "$diet\blender-launcher.exe" -ErrorAction SilentlyContinue
        Remove-Item "$diet\blender.pdb" -Force -ErrorAction SilentlyContinue
        Write-Host "Stripping Unused Libraries (Cycles, HiPRT, OIDN GPU)..."
        # KEEP cycles_kernel_oneapi_aot.dll - It is a hard dependency for Blender 4.5+ on Windows
        # Remove HiPRT (AMD Raytracing)
        Remove-Item "$diet\hiprt64.dll" -ErrorAction SilentlyContinue
        # Remove OIDN GPU Backends (Keep CPU and Core)
        Remove-Item "$diet\blender.shared\OpenImageDenoise_device_*.dll" -ErrorAction SilentlyContinue
        
        Write-Host "Stripping Unused Addons..."
        $addons = "$diet\4.5\scripts\addons_core"
        $list = @("cycles", "hydra_storm", "io_scene_fbx", "io_scene_gltf2", "rigify", "pose_library", "io_anim_bvh", "io_curve_svg", "io_mesh_uv_layout", "node_wrangler", "ui_translate", "viewport_vr_preview")
        foreach ($item in $list) { Remove-Item "$addons\$item" -Recurse -Force -ErrorAction SilentlyContinue }
        Remove-Item "$diet\4.5\datafiles\studiolights", "$diet\4.5\datafiles\icons" -Recurse -Force -ErrorAction SilentlyContinue

    - name: Patch Addon (No Cycles Dependency)
      shell: powershell
      run: |
        $File = "blender-diet/4.5/scripts/addons_core/io_scene_importldraw/loadldraw/loadldraw.py"
        $Content = Get-Content $File -Raw
        
        # Patch setupRealisticLook (Engine Switch)
        $Content = $Content.Replace("scene.render.engine = 'CYCLES'", "try:`n        scene.render.engine = 'CYCLES'`n    except:`n        pass")
        
        # Patch setupInstructionsLook (Transparency Settings)
        # We replace the first line of the block with a try, and indent the rest if possible, 
        # or easier: just comment out the dangerous lines if we can match them.
        # Since multiline replacement is tricky in PowerShell strings without regex, we'll try a regex replace.
        
        # Regex to wrap the specific failing block
        # Matches "scene.cycles.film_transparent = True" ... down to ... "scene.cycles.transparent_max_bounces = 80"
        # We will simply replace the specific lines with "pass # patched" to neutralize them effectively
        
        $Content = $Content.Replace("scene.cycles.film_transparent = True", "pass # scene.cycles.film_transparent = True")
        $Content = $Content.Replace("if scene.cycles.transparent_max_bounces < 80:", "if False: # if scene.cycles.transparent_max_bounces < 80:")
        $Content = $Content.Replace("scene.cycles.transparent_max_bounces = 80", "pass # scene.cycles.transparent_max_bounces = 80")
        
        Set-Content -Path $File -Value $Content

    - name: Package
      shell: powershell
      run: |
        New-Item -ItemType Directory -Force -Path "dist/LDraw2Print"
        Move-Item -Path "blender-diet" -Destination "dist/LDraw2Print/blender"
        Copy-Item -Path "export_cli.py" -Destination "dist/LDraw2Print/converter.py"
        $BatContent = @"
        @echo off
        setlocal
        set "TARGET=%~1"
        if "%TARGET%"=="" (
            echo Drag and drop an .ldr file onto this script!
            pause
            exit /b
        )
        echo Processing: %TARGET%
        "%~dp0blender\blender.exe" --background --python "%~dp0converter.py" -- "%TARGET%" "%~dp0export_output"
        echo Done! Output is in the export_output folder.
        pause
        "@
        Set-Content -Path "dist/LDraw2Print/LDraw2Print.bat" -Value $BatContent
        
        # Determine Version for Filename
        $InputVer = "${{ github.event.inputs.version }}"
        if ($InputVer -ne "") {
            $Version = $InputVer
        } elseif ("${{ github.event_name }}" -eq "release") {
            $Version = "${{ github.ref_name }}"
        } else {
            $Version = "build"
        }
        
        $ZipName = "LDraw2Print-${Version}.zip"
        Compress-Archive -Path "dist/LDraw2Print" -DestinationPath "$ZipName" -CompressionLevel Optimal
        
        echo "ZIP_NAME=$ZipName" >> $env:GITHUB_ENV

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: LDraw2Print-Build
        path: dist/LDraw2Print

    - name: Upload to Release
      if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.event.inputs.version != '')
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ env.ZIP_NAME }}
        tag_name: ${{ github.event.inputs.version }}
        name: ${{ github.event.inputs.title }}
        draft: false
        prerelease: false